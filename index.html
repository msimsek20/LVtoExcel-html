<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LV → Excel (DREIPLUS Preset v3)</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:0}
    .wrap{display:grid;grid-template-columns:460px 1fr;gap:12px;height:100vh}
    .panel{padding:12px;border-right:1px solid #ddd;overflow:auto}
    .viewer{padding:12px;overflow:auto}
    label{display:block;font-size:12px;margin-top:10px;color:#333}
    input,button,select{width:100%;box-sizing:border-box;padding:8px;margin-top:6px}
    .btnrow{display:flex;gap:8px;margin-top:10px}
    .btnrow button{flex:1}
    canvas{border:1px solid #ccc;max-width:100%;height:auto}
    pre{height:220px;overflow:auto;border:1px solid #ccc;background:#fff;padding:8px}
    .hint{font-size:12px;color:#666;margin-top:6px;line-height:1.35}
    table{border-collapse:collapse;font-size:12px}
    th,td{border:1px solid #ccc;padding:4px;vertical-align:top}
  </style>

  <!-- Local copies (NO CDN) -->
  <script src="./pdf.min.js"></script>
  <script src="./xlsx.full.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <div class="hint"><b>GitHub Pages (https)</b> • DREIPLUS preset (v3) • PDF dosyası tarayıcıda kalır</div>

    <label>PDF seç</label>
    <input id="pdfFile" type="file" accept="application/pdf" />

    <label>Sayfa aralığı (opsiyonel)</label>
    <div class="btnrow">
      <input id="pageFrom" type="number" min="1" placeholder="Başlangıç (örn 349)" />
      <input id="pageTo" type="number" min="1" placeholder="Bitiş (örn 355)" />
    </div>
    <div class="hint">Boş bırakırsan, yüklediğin PDF içindeki tüm sayfalar taranır.</div>

    <div class="btnrow">
      <button id="loadBtn">PDF laden</button>
      <button id="extractBtn">LV Extract</button>
    </div>

    <div class="btnrow">
      <button id="xlsxBtn">Export XLSX</button>
      <button id="csvBtn">Export CSV</button>
    </div>

    <div class="hint">
      <b>DREIPLUS mantığı:</b> Pos satırı (örn <code>1.012.01.0010</code>) görülünce yeni kalem başlar.
      Kalem bitişi: sonraki Pos satırı. EP/GP: satır içinde <code>EP ... GP ...</code> yakalanır.
    </div>

    <label>Log</label>
    <pre id="log"></pre>
  </div>

  <div class="viewer">
    <canvas id="canvas"></canvas>
    <div id="out"></div>
  </div>
</div>

<script>
let pdfDoc = null;
let extractedRows = null;

const logEl = document.getElementById('log');
function log(msg){ logEl.textContent += msg + "\n"; logEl.scrollTop = logEl.scrollHeight; }

document.getElementById('loadBtn').addEventListener('click', loadPdf);
document.getElementById('extractBtn').addEventListener('click', extractLV);
document.getElementById('csvBtn').addEventListener('click', exportCSV);
document.getElementById('xlsxBtn').addEventListener('click', exportXLSX);

// ✅ Worker: aynı klasörde pdf.worker.min.js olmalı
if (window.pdfjsLib && pdfjsLib.GlobalWorkerOptions) {
  pdfjsLib.GlobalWorkerOptions.workerSrc = "./pdf.worker.min.js";
}

function normText(s){ return (s||"").replace(/\s+/g," ").trim(); }

function parseNumberDE(s){
  s = normText(s);
  if(!s) return null;
  s = s.replace(/[^0-9,\.\-]/g,"");
  if(!s) return null;
  if(s.indexOf(",") >= 0){
    s = s.replace(/\./g,"").replace(",", ".");
  }
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}

// DREIPLUS position item pattern: ... .0010 (last segment 4 digits)
function isItemPos(s){
  s = normText(s);
  return /^\d+(?:\.\d+){2,}\.\d{4}$/.test(s);
}

// Title pattern like 1.012.01 (no 4-digit at end)
function isTitlePos(s){
  s = normText(s);
  return /^\d+(?:\.\d+){2,}$/.test(s) && !isItemPos(s);
}

// Convert pdf.js text items to lines (y clustering)
function itemsToLines(items){
  const pts = items
    .map(it => ({ x: it.transform[4], y: it.transform[5], s: normText(it.str) }))
    .filter(p => p.s);

  // top->bottom
  pts.sort((a,b)=> (b.y-a.y) || (a.x-b.x));

  const lines = [];
  const yTol = 2.2;
  for(const p of pts){
    let line = lines.find(l => Math.abs(l.y - p.y) <= yTol);
    if(!line){
      line = { y: p.y, parts: [] };
      lines.push(line);
    }
    line.parts.push({x:p.x, s:p.s});
  }

  for(const l of lines){
    l.parts.sort((a,b)=>a.x-b.x);
    l.text = l.parts.map(pp=>pp.s).join(" ").trim();
    l.minX = l.parts.length ? l.parts[0].x : 999999;
  }

  lines.sort((a,b)=>b.y-a.y);
  return lines;
}

function isNoiseLine(t){
  t = normText(t);
  if(!t) return true;

  // headers / footers / carry-overs
  const bad = [
    /^Verlagsgesellschaft/i,
    /^Schätz-?LV/i,
    /^DREIPLUS/i,
    /^ZTV-?LV-?Texte/i,
    /^Telefon/i,
    /^rudolf-mueller/i,
    /^Fortsetzung auf nächster Seite/i,
    /^Übertrag/i,
    /^Alle Einzelbeträge netto/i,
    /^B=\s*Bedarfsposition/i,
    /^Seite \d+ von \d+/i,
    /^Nr\.?\b/i,
    /^Menge\/Einheit/i,
    /^EP\b/i,
    /^GP\b/i
  ];
  return bad.some(rx => rx.test(t));
}

// Extract unit/EP/GP from lines like: "m EP .... GP .... 5,10 -"
function tryParsePrices(lineText){
  const t = normText(lineText);
  if(!/\bEP\b/i.test(t)) return null;

  // unit is first token before EP if it looks like letters (m, m2, St, etc.)
  let unit = null;
  const unitMatch = t.match(/^([A-Za-z]{1,4}\d{0,2})\s+EP\b/i);
  if(unitMatch) unit = unitMatch[1];

  // Find all numbers in the line
  const nums = t.match(/-?\d{1,3}(?:\.\d{3})*(?:,\d+)?|-?\d+(?:,\d+)?/g) || [];
  // Remove false positives like years 2024 when present with EP? unlikely but safe:
  const numVals = nums
    .map(n => ({ raw:n, val: parseNumberDE(n) }))
    .filter(o => o.val !== null && o.val < 1e6); // guard

  // Decide EP/GP:
  // - If two reasonable numbers: assume EP then GP (common)
  // - If one number: assume EP
  let EP = null, GP = null;
  if(numVals.length >= 2){
    EP = numVals[0].val;
    GP = numVals[1].val;
  }else if(numVals.length === 1){
    EP = numVals[0].val;
  }

  return { unit, EP, GP };
}

async function loadPdf(){
  try{
    logEl.textContent = "";
    log("loadPdf() başladı…");
    if(!window.pdfjsLib) throw new Error("pdf.min.js yüklenmedi.");
    const f = document.getElementById("pdfFile").files[0];
    if(!f) { alert("Önce PDF seç."); return; }
    const buf = await f.arrayBuffer();
    log("PDF boyutu: " + (buf.byteLength/1024/1024).toFixed(2) + " MB");

    const loadingTask = pdfjsLib.getDocument({
      data: buf,
      disableFontFace: true,
      useSystemFonts: true,
      isEvalSupported: false,
      stopAtErrors: false,
    });

    loadingTask.onProgress = (p)=>{
      try{
        if(p && p.total){
          const pct = Math.round((p.loaded/p.total)*100);
          log("Yükleniyor: " + pct + "%");
        }
      }catch(e){}
    };

    pdfDoc = await loadingTask.promise;
    log("PDF geladen: " + pdfDoc.numPages + " Seiten");

    await renderPage(1);
    log("İlk sayfa çizildi.");
  }catch(e){
    log("HATA: " + (e && e.message ? e.message : e));
    alert("Hata: " + (e && e.message ? e.message : e));
  }
}

async function renderPage(pno){
  const page = await pdfDoc.getPage(pno);
  const vp = page.getViewport({ scale: 1.5 });
  const canvas = document.getElementById("canvas");
  canvas.width = Math.floor(vp.width);
  canvas.height = Math.floor(vp.height);
  await page.render({ canvasContext: canvas.getContext("2d"), viewport: vp }).promise;
}

async function extractLV(){
  try{
    if(!pdfDoc){ alert("Önce PDF laden."); return; }
    log("LV Extract başladı…");

    const out = [];

    const fromUI = Number(document.getElementById("pageFrom").value);
    const toUI = Number(document.getElementById("pageTo").value);

    const startPage = Number.isFinite(fromUI) && fromUI>0 ? 1 : 1; // UI values are for original document; our PDF is already cropped
    const endPage = pdfDoc.numPages;

    // We ignore original page numbers; we will store pdf page index, and try to read real "Seite XXX" if present.
    for(let p=1;p<=pdfDoc.numPages;p++){
      const page = await pdfDoc.getPage(p);
      const tc = await page.getTextContent();
      const lines = itemsToLines(tc.items);

      // Try to detect printed page number in text: "Seite 349 von 4457"
      let printedPage = null;
      for(const l of lines.slice(-15)){
        const m = l.text.match(/Seite\s+(\d+)\s+von\s+\d+/i);
        if(m){ printedPage = Number(m[1]); break; }
      }

      let current = null;

      for(const l of lines){
        const t = normText(l.text);
        if(isNoiseLine(t)) continue;

        // Detect a pos token on the far left. We look at the first token.
        const firstTok = t.split(" ")[0];

        // Skip title rows like "1.012.01 Titel ..."
        if(isTitlePos(firstTok) && /\bTitel\b/i.test(t)){
          continue;
        }

        if(isItemPos(firstTok)){
          if(current){
            current.Beschreibung = normText(current.Beschreibung);
            out.push(current);
          }
          const rest = normText(t.slice(firstTok.length));
          current = {
            Seite: printedPage ?? p,
            Pos: firstTok,
            Menge: "",
            Einheit: "",
            EP: "",
            GP: "",
            Beschreibung: rest,
          };
          continue;
        }

        // Price/unit lines: may appear on continuation page without repeating Pos
        const pr = tryParsePrices(t);
        if(pr && current){
          if(pr.unit && !current.Einheit) current.Einheit = pr.unit;
          if(pr.EP !== null && pr.EP !== undefined && pr.EP !== "" && !current.EP) current.EP = pr.EP;
          if(pr.GP !== null && pr.GP !== undefined && pr.GP !== "" && !current.GP) current.GP = pr.GP;
          continue; // don't add dotted line into description
        }

        // Continuation marker: ignore
        if(/^Fortsetzung von Eintrag/i.test(t)) continue;

        if(current){
          // Append to description
          current.Beschreibung += (current.Beschreibung ? " " : "") + t;
        }
      }

      if(current){
        current.Beschreibung = normText(current.Beschreibung);
        out.push(current);
      }
    }

    // Post-process: remove empty/garbage
    const cleaned = out
      .filter(r => r.Pos && isItemPos(r.Pos))
      .map(r => {
        // If unit still empty, default to 'm' when EP exists and PDF had m EP lines (common)
        if(!r.Einheit && r.EP) r.Einheit = "m";
        return r;
      });

    extractedRows = cleaned;

    log("Bitti. Bulunan poz sayısı: " + cleaned.length);

    // Preview
    let html = "<table><tr><th>Seite</th><th>Pos</th><th>Menge</th><th>Einheit</th><th>EP</th><th>GP</th><th>Beschreibung</th></tr>";
    cleaned.slice(0,50).forEach(r=>{
      html += "<tr>" +
        "<td>"+escapeHtml(r.Seite)+"</td>" +
        "<td>"+escapeHtml(r.Pos)+"</td>" +
        "<td>"+escapeHtml(r.Menge)+"</td>" +
        "<td>"+escapeHtml(r.Einheit)+"</td>" +
        "<td>"+escapeHtml(r.EP)+"</td>" +
        "<td>"+escapeHtml(r.GP)+"</td>" +
        "<td>"+escapeHtml((r.Beschreibung||"").slice(0,220))+"</td>" +
      "</tr>";
    });
    html += "</table><div class='hint'>İlk 50 satır gösteriliyor. Export ile tümü iner.</div>";
    document.getElementById("out").innerHTML = html;

  }catch(e){
    log("HATA: " + (e && e.message ? e.message : e));
    alert("Hata: " + (e && e.message ? e.message : e));
  }
}

function escapeHtml(s){
  return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

function exportCSV(){
  if(!extractedRows || !extractedRows.length){ alert("Önce LV Extract."); return; }
  const cols = ["Seite","Pos","Menge","Einheit","EP","GP","Beschreibung"];
  const esc = (v)=>(''+(v??'')).replace(/"/g,'""');
  const csv = cols.join(",") + "\n" + extractedRows.map(r =>
    cols.map(c => `"${esc(r[c])}"`).join(",")
  ).join("\n");
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv], {type:"text/csv;charset=utf-8"}));
  a.download = "dreiplus_lv.csv";
  a.click();
}

function exportXLSX(){
  if(!extractedRows || !extractedRows.length){ alert("Önce LV Extract."); return; }
  if(!window.XLSX){ alert("xlsx.full.min.js yüklenmedi."); return; }

  const header = ["Seite","Pos","Menge","Einheit","EP","GP","Beschreibung"];
  const data = [header, ...extractedRows.map(r => header.map(h => r[h] ?? ""))];
  const ws = XLSX.utils.aoa_to_sheet(data);
  ws["!cols"] = [
    { wch: 6 },  // Seite
    { wch: 18 }, // Pos
    { wch: 10 }, // Menge
    { wch: 8 },  // Einheit
    { wch: 10 }, // EP
    { wch: 10 }, // GP
    { wch: 90 }, // Beschreibung
  ];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "DREIPLUS_LV");
  XLSX.writeFile(wb, "DREIPLUS_LV.xlsx");
}
</script>
</body>
</html>
