<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LVtoExcel Pro - V3.1 (Fixed)</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root { --primary: #0969da; --border:#d0d7de; --bg:#f6f8fa; --white:#ffffff; --danger:#cf222e; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 20px; color:#24292f; background:var(--bg); }
    
    /* Layout */
    .container { max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; gap: 15px; }
    .card { background: var(--white); border: 1px solid var(--border); border-radius: 6px; padding: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    
    /* Controls */
    h1 { font-size: 20px; margin: 0; color: var(--primary); }
    .btn { background: #2da44e; color: white; border: 1px solid rgba(27,31,36,0.15); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; }
    .btn:hover { opacity: 0.9; }
    .btn:disabled { background: #94d3a2; cursor: not-allowed; opacity: 0.6; }
    .btn-danger { background: var(--danger); }
    .btn-secondary { background: #f6f8fa; color: #24292f; border-color: var(--border); }
    
    select, input[type="file"] { padding: 8px; border-radius: 5px; border: 1px solid var(--border); }

    /* Canvas Wrapper */
    #canvasWrapper { position: relative; display: inline-block; border: 1px solid #999; box-shadow: 0 4px 10px rgba(0,0,0,0.1); background: #555; overflow: hidden; }
    canvas { display: block; }
    .guide-layer { position: absolute; top: 0; left: 0; cursor: crosshair; }
    
    /* Progress & Preview */
    #progressContainer { width: 100%; display: none; margin-top: 10px; background: #eee; border-radius: 10px; overflow: hidden; }
    #progressBar { width: 0%; height: 20px; background: #2da44e; transition: width 0.3s; }
    #progressText { font-size: 12px; text-align: center; margin-top: 4px; color: #666; }
    
    #previewArea { overflow-x: auto; max-height: 400px; margin-top: 10px; border: 1px solid var(--border); background: #fff; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: left; white-space: pre-wrap; vertical-align: top; }
    th { background: #f0f0f0; position: sticky; top: 0; font-weight: bold; }
    tr:nth-child(even) { background: #f9f9f9; }
    
    /* Hints */
    .hint { font-size: 12px; color: #666; margin-top: 5px; }
    .mode-badge { background: #eefbff; color: #0969da; padding: 2px 6px; border-radius: 4px; font-size: 11px; border: 1px solid #bdeeff; }
  </style>
</head>
<body>

<div class="container">
  <div class="card row" style="justify-content: space-between;">
    <div class="row">
      <h1>LVtoExcel <span style="font-size:12px; color:#666;">Pro V3.1</span></h1>
      <input type="file" id="fileInput" accept="application/pdf" />
    </div>
    <div class="row">
      <label>Ã‡alÄ±ÅŸma Modu:</label>
      <select id="modeSelect">
        <option value="LV">Ä°hale/LV Modu (AkÄ±llÄ±)</option>
        <option value="GENERAL">Serbest Tablo Modu (Manuel)</option>
      </select>
    </div>
  </div>

  <div class="card" id="controlPanel">
    <div class="row">
      <button id="btnPrev" class="btn btn-secondary">Previous Page</button>
      <span id="pageInfo" style="font-variant-numeric: tabular-nums;">0 / 0</span>
      <button id="btnNext" class="btn btn-secondary">Next Page</button>
      
      <div style="flex-grow:1"></div>
      
      <button id="btnClearGuides" class="btn btn-danger">Ã‡izgileri SÄ±fÄ±rla</button>
      <button id="btnExtract" class="btn" disabled>Veriyi Ã‡ek (Extract)</button>
    </div>

    <div class="hint">
      <span id="guideHint">ðŸ”´ KÄ±rmÄ±zÄ±: Header/Footer (GÃ¶rmezden gel) | ðŸ”µ Mavi: SÃ¼tun AyracÄ± (SÃ¼rÃ¼kle bÄ±rak)</span>
      <span id="generalModeHint" style="display:none; color: var(--primary); font-weight:bold;"> :: TÄ±klayarak yeni mavi Ã§izgi ekle, saÄŸ tÄ±klayarak sil.</span>
    </div>

    <div id="progressContainer">
      <div id="progressBar"></div>
    </div>
    <div id="progressText"></div>
  </div>

  <div style="text-align:center; background:#333; padding:20px; border-radius:8px;">
    <div id="canvasWrapper">
      <canvas id="the-canvas"></canvas>
      <canvas id="guide-canvas" class="guide-layer"></canvas>
    </div>
  </div>

  <div class="card">
    <div class="row" style="margin-bottom:10px;">
      <h3>SonuÃ§ Ã–nizleme <span id="rowCountBadge" class="mode-badge">0 satÄ±r</span></h3>
      <div style="flex-grow:1"></div>
      
      <div style="font-size:12px; display:flex; align-items:center; gap:5px; background:#f0f0f0; padding:5px; border-radius:4px;">
        <input type="checkbox" id="chkCloud" checked>
        <label for="chkCloud" title="Anonim geliÅŸtirici veri toplama">GeliÅŸtirici desteÄŸi (Veri paylaÅŸÄ±mÄ±)</label>
      </div>
      
      <button id="btnExport" class="btn" style="background:#0969da;" disabled>Excel Ä°ndir (.xlsx)</button>
    </div>
    <div id="previewArea">
      <div style="padding:20px; text-align:center; color:#999;">Veri Ã§ekildikten sonra tablo burada gÃ¶rÃ¼necek.</div>
    </div>
  </div>
</div>

<script>
  /*******************************************************
   * AYARLAR VE DEÄžÄ°ÅžKENLER
   *******************************************************/
  const APPS_SCRIPT_URL = ""; // Buraya Apps Script URL'si gelecek

  let pdfDoc = null;
  let pageNum = 1;
  let pdfScale = 1.3; // VarsayÄ±lan zoom
  let canvas, ctx, guideCanvas, gCtx;
  let extractedData = [];
  
  // Rehberler (0.0 - 1.0 arasÄ±nda normalize edilmiÅŸ deÄŸerler)
  let extractionMode = "LV"; 
  let guidesLV = { header: 0.1, footer: 0.9, cols: [0.10, 0.50, 0.65, 0.75, 0.85] };
  let guidesGeneral = { header: 0.05, footer: 0.95, cols: [0.2, 0.4, 0.6, 0.8] };

  // SÃ¼rÃ¼kleme Durumu
  let dragTarget = null; 
  let isDragging = false;

  /*******************************************************
   * BAÅžLANGIÃ‡
   *******************************************************/
  window.addEventListener('DOMContentLoaded', () => {
    canvas = document.getElementById('the-canvas');
    ctx = canvas.getContext('2d');
    guideCanvas = document.getElementById('guide-canvas');
    gCtx = guideCanvas.getContext('2d');
    
    // Event Listeners
    guideCanvas.addEventListener('mousedown', onMouseDown);
    window.addEventListener('mousemove', onMouseMove); // Pencere geneli, dÄ±ÅŸarÄ± kaÃ§arsa diye
    window.addEventListener('mouseup', onMouseUp);
    guideCanvas.addEventListener('contextmenu', onRightClick);

    document.getElementById('fileInput').addEventListener('change', handleFileSelect);
    document.getElementById('btnPrev').addEventListener('click', () => renderPage(pageNum - 1));
    document.getElementById('btnNext').addEventListener('click', () => renderPage(pageNum + 1));
    document.getElementById('modeSelect').addEventListener('change', changeMode);
    document.getElementById('btnExtract').addEventListener('click', startExtraction);
    document.getElementById('btnExport').addEventListener('click', exportToExcel);
    document.getElementById('btnClearGuides').addEventListener('click', resetGuides);
  });

  /*******************************************************
   * PDF Ä°ÅžLEME (RENDER)
   *******************************************************/
  async function handleFileSelect(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const arrayBuffer = await file.arrayBuffer();
    try {
      pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
      document.getElementById('btnExtract').disabled = false;
      renderPage(1);
    } catch (err) {
      alert("PDF yÃ¼klenirken hata oluÅŸtu: " + err.message);
    }
  }

  async function renderPage(num) {
    if (!pdfDoc || num < 1 || num > pdfDoc.numPages) return;
    pageNum = num;
    document.getElementById('pageInfo').textContent = `${pageNum} / ${pdfDoc.numPages}`;

    const page = await pdfDoc.getPage(num);
    const viewport = page.getViewport({ scale: pdfScale });

    // Canvas boyutlarÄ±nÄ± ayarla
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    guideCanvas.width = viewport.width;
    guideCanvas.height = viewport.height;

    // PDF'i Ã§iz
    await page.render({ canvasContext: ctx, viewport: viewport }).promise;
    drawGuides();
  }

  function getActiveGuides() {
    return extractionMode === 'LV' ? guidesLV : guidesGeneral;
  }

  /*******************************************************
   * REHBER Ã‡Ä°ZÄ°MÄ° (GUIDES)
   *******************************************************/
  function drawGuides() {
    gCtx.clearRect(0, 0, guideCanvas.width, guideCanvas.height);
    const w = guideCanvas.width;
    const h = guideCanvas.height;
    const g = getActiveGuides();

    // 1. KÄ±rmÄ±zÄ± Alanlar (Yasak BÃ¶lgeler)
    gCtx.fillStyle = "rgba(207, 34, 46, 0.15)";
    // Ãœst
    gCtx.fillRect(0, 0, w, g.header * h);
    // Alt
    gCtx.fillRect(0, g.footer * h, w, h - (g.footer * h));
    
    gCtx.strokeStyle = "#cf222e";
    gCtx.lineWidth = 2;
    gCtx.beginPath(); gCtx.moveTo(0, g.header * h); gCtx.lineTo(w, g.header * h); gCtx.stroke();
    gCtx.beginPath(); gCtx.moveTo(0, g.footer * h); gCtx.lineTo(w, g.footer * h); gCtx.stroke();

    // 2. Mavi SÃ¼tun Ã‡izgileri
    gCtx.strokeStyle = "#0969da";
    gCtx.lineWidth = 2;
    gCtx.setLineDash([5, 3]);
    g.cols.forEach(xNorm => {
      const x = xNorm * w;
      gCtx.beginPath(); gCtx.moveTo(x, 0); gCtx.lineTo(x, h); gCtx.stroke();
    });
    gCtx.setLineDash([]);
  }

  /*******************************************************
   * ETKÄ°LEÅžÄ°M (DRAG & DROP)
   *******************************************************/
  function changeMode() {
    extractionMode = document.getElementById('modeSelect').value;
    document.getElementById('guideHint').style.display = extractionMode === 'LV' ? 'inline' : 'none';
    document.getElementById('generalModeHint').style.display = extractionMode === 'GENERAL' ? 'inline' : 'none';
    drawGuides();
  }

  function resetGuides() {
    if (extractionMode === 'GENERAL') guidesGeneral.cols = [0.2, 0.4, 0.6, 0.8];
    else guidesLV.cols = [0.10, 0.50, 0.65, 0.75, 0.85];
    drawGuides();
  }

  function onMouseDown(e) {
    const rect = guideCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const w = guideCanvas.width;
    const h = guideCanvas.height;
    const g = getActiveGuides();

    // Header/Footer yakalama (Hassasiyet 10px)
    if (Math.abs(y - g.header * h) < 10) { isDragging = true; dragTarget = 'header'; return; }
    if (Math.abs(y - g.footer * h) < 10) { isDragging = true; dragTarget = 'footer'; return; }
    
    // SÃ¼tun yakalama
    for (let i = 0; i < g.cols.length; i++) {
      if (Math.abs(x - g.cols[i] * w) < 10) {
        isDragging = true; dragTarget = i;
        return;
      }
    }

    // General Modda boÅŸluÄŸa tÄ±klayÄ±nca YENÄ° Ã‡Ä°ZGÄ° ekle
    if (extractionMode === 'GENERAL' && !isDragging) {
      g.cols.push(x / w);
      g.cols.sort((a,b) => a-b);
      drawGuides();
    }
  }

  function onMouseMove(e) {
    if (!isDragging) return;
    const rect = guideCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const w = guideCanvas.width;
    const h = guideCanvas.height;
    const g = getActiveGuides();

    if (dragTarget === 'header') g.header = Math.max(0, Math.min(y / h, g.footer - 0.05));
    else if (dragTarget === 'footer') g.footer = Math.max(g.header + 0.05, Math.min(y / h, 1));
    else if (typeof dragTarget === 'number') g.cols[dragTarget] = Math.max(0, Math.min(x / w, 1));

    drawGuides();
  }

  function onMouseUp() { isDragging = false; dragTarget = null; }

  function onRightClick(e) {
    if (extractionMode !== 'GENERAL') return;
    e.preventDefault();
    const rect = guideCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const w = guideCanvas.width;
    const g = getActiveGuides();
    
    // En yakÄ±n Ã§izgiyi bul ve sil
    const removeIdx = g.cols.findIndex(c => Math.abs((c*w) - x) < 15);
    if (removeIdx !== -1) {
      g.cols.splice(removeIdx, 1);
      drawGuides();
    }
  }

  /*******************************************************
   * ANA MOTOR: VERÄ° Ã‡EKME (EXTRACTION)
   *******************************************************/
  async function startExtraction() {
    if (!pdfDoc) return;
    
    extractedData = [];
    document.getElementById('progressContainer').style.display = 'block';
    const pBar = document.getElementById('progressBar');
    const pText = document.getElementById('progressText');
    
    const g = getActiveGuides();

    // TÃ¼m sayfalarÄ± dolaÅŸ
    for (let i = 1; i <= pdfDoc.numPages; i++) {
      // UI GÃ¼ncelle (HÄ±zlÄ± olmasÄ± iÃ§in setTimeout ile wrap edilebilir ama basitlik iÃ§in direkt yazÄ±yoruz)
      const percent = Math.round((i / pdfDoc.numPages) * 100);
      pBar.style.width = percent + "%";
      pText.innerText = `Sayfa ${i} iÅŸleniyor...`;

      const page = await pdfDoc.getPage(i);
      // Koordinat dÃ¶nÃ¼ÅŸÃ¼mÃ¼ iÃ§in 1.0 scale ile viewport alÄ±yoruz
      const viewport = page.getViewport({ scale: 1.0 });
      const textContent = await page.getTextContent();
      
      const w = viewport.width;
      const h = viewport.height;

      // 1. KoordinatlarÄ± Ekran KoordinatÄ±na (Top-Left 0,0) Ã‡evir
      // Bu adÄ±m CRITICAL: PDF.js'in transform matrisini kullanarak doÄŸru x,y'yi buluruz.
      let items = textContent.items.map(item => {
        // Fix: viewport.convertToViewportPoint kullanÄ±mÄ± (v3+ uyumlu)
        // transform[4] = x, transform[5] = y
        const [vx, vy] = viewport.convertToViewportPoint(item.transform[4], item.transform[5]);
        return {
          str: item.str,
          x: vx, 
          y: vy, 
          hasEOL: item.hasEOL
        };
      });

      // 2. KÄ±rmÄ±zÄ± Alan Filtresi (Header/Footer)
      const limitY_Top = g.header * h;
      const limitY_Bottom = g.footer * h;
      
      items = items.filter(item => item.y > limitY_Top && item.y < limitY_Bottom);

      // 3. SÄ±ralama: Y koordinatÄ±na gÃ¶re (YukarÄ±dan aÅŸaÄŸÄ±ya)
      // SatÄ±r iÃ§i sÄ±ralama iÃ§in Y farkÄ± azsa X'e bak.
      items.sort((a, b) => {
        if (Math.abs(a.y - b.y) < 5) return a.x - b.x; // AynÄ± satÄ±r
        return a.y - b.y; // FarklÄ± satÄ±r (Top-down)
      });

      // 4. Mod'a GÃ¶re Ä°ÅŸle
      if (extractionMode === 'LV') {
        extractedData.push(...processLVPage(items, w, g.cols));
      } else {
        extractedData.push(...processGeneralPage(items, w, g.cols));
      }
    }
    
    pText.innerText = "Ä°ÅŸlem TamamlandÄ±!";
    renderPreview(extractedData);
    document.getElementById('btnExport').disabled = false;
  }

  // --- LV Modu MantÄ±ÄŸÄ± ---
  function processLVPage(items, pgWidth, colsNorm) {
    let rows = [];
    let currentRow = null;
    const limits = colsNorm.map(c => c * pgWidth); // Pixel sÄ±nÄ±rlarÄ±

    items.forEach(item => {
      // Hangi sÃ¼tunda?
      let colIdx = 0;
      for (let i=0; i<limits.length; i++) {
        if (item.x > limits[i]) colIdx = i + 1;
      }

      // Yeni SatÄ±r Tespiti: Ä°lk sÃ¼tunda (Poz No) metin varsa
      if (colIdx === 0 && item.str.trim().length > 0) {
        if (currentRow) rows.push(currentRow);
        currentRow = { pos: item.str, desc: "", unit: "", qty: "", price: "", total: "" };
      } else if (currentRow) {
        const val = item.str.trim();
        if(!val) return;
        
        // Veriyi ilgili hÃ¼creye ekle
        if (colIdx === 1) currentRow.desc += " " + val;
        else if (colIdx === 2) currentRow.unit = val;
        else if (colIdx === 3) currentRow.qty = val;
        else if (colIdx === 4) currentRow.price = val;
        else if (colIdx === 5) currentRow.total = val;
      }
    });
    if (currentRow) rows.push(currentRow);
    return rows;
  }

  // --- General Mod MantÄ±ÄŸÄ± ---
  function processGeneralPage(items, pgWidth, colsNorm) {
    let rows = [];
    let currentRow = [];
    let lastY = -999;
    const limits = colsNorm.map(c => c * pgWidth);

    items.forEach(item => {
      // SatÄ±r AyrÄ±mÄ±: Y farkÄ± 10px'den bÃ¼yÃ¼kse yeni satÄ±r
      if (Math.abs(item.y - lastY) > 10) {
        if (currentRow.length > 0) rows.push(currentRow);
        currentRow = new Array(limits.length + 1).fill("");
        lastY = item.y;
      }

      // SÃ¼tun Tespiti
      let colIdx = 0;
      for (let i=0; i<limits.length; i++) {
        if (item.x > limits[i]) colIdx = i + 1;
      }
      
      currentRow[colIdx] += (currentRow[colIdx] ? " " : "") + item.str.trim();
    });

    if (currentRow.length > 0) rows.push(currentRow);
    return rows;
  }

  /*******************************************************
   * EXCEL VE YARDIMCILAR
   *******************************************************/
  function cleanNumber(str) {
    if (!str) return 0;
    // Harfleri temizle
    let clean = str.replace(/[^0-9,.-]/g, '').trim();
    // TÃ¼rkÃ§e format (1.250,50) -> Ä°ngilizce (1250.50)
    if (clean.includes(',') && clean.includes('.')) {
      clean = clean.replace(/\./g, '').replace(',', '.');
    } else if (clean.includes(',')) {
      clean = clean.replace(',', '.');
    }
    return parseFloat(clean) || 0;
  }

  function renderPreview(data) {
    const div = document.getElementById('previewArea');
    document.getElementById('rowCountBadge').textContent = data.length + " satÄ±r";
    div.innerHTML = "";
    
    const table = document.createElement('table');
    const trH = document.createElement('tr');
    
    // BaÅŸlÄ±klar
    if (extractionMode === 'LV') {
      ['Poz No', 'AÃ§Ä±klama', 'Birim', 'Miktar', 'B.Fiyat', 'Toplam'].forEach(h => {
        const th = document.createElement('th'); th.textContent = h; trH.appendChild(th);
      });
    } else {
      const colCount = data[0] ? data[0].length : 5;
      for(let i=0; i<colCount; i++) {
        const th = document.createElement('th'); th.textContent = `SÃ¼tun ${i+1}`; trH.appendChild(th);
      }
    }
    table.appendChild(trH);

    // Ä°lk 100 satÄ±r Ã¶nizleme
    data.slice(0, 100).forEach(row => {
      const tr = document.createElement('tr');
      if (extractionMode === 'LV') {
        [row.pos, row.desc, row.unit, row.qty, row.price, row.total].forEach(c => {
          const td = document.createElement('td'); td.textContent = c; tr.appendChild(td);
        });
      } else {
        row.forEach(c => {
          const td = document.createElement('td'); td.textContent = c; tr.appendChild(td);
        });
      }
      table.appendChild(tr);
    });
    div.appendChild(table);
  }

  function exportToExcel() {
    let ws_data = [];
    
    // BaÅŸlÄ±k ve Veri HazÄ±rlama
    if (extractionMode === 'LV') {
      ws_data.push(['Poz No', 'TanÄ±m', 'Birim', 'Miktar', 'Birim Fiyat', 'Toplam Fiyat']);
      extractedData.forEach(r => {
        ws_data.push([
          r.pos, r.desc, r.unit, 
          cleanNumber(r.qty), cleanNumber(r.price), cleanNumber(r.total)
        ]);
      });
    } else {
      extractedData.forEach(row => {
        // Otomatik sayÄ± dÃ¶nÃ¼ÅŸÃ¼mÃ¼
        ws_data.push(row.map(c => {
          return (c.match(/^[0-9.,]+$/) && c.length < 15) ? cleanNumber(c) : c;
        }));
      });
    }

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Export");
    
    const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
    const blob = new Blob([wbout], {type:"application/octet-stream"});
    const url = window.URL.createObjectURL(blob);
    
    const a = document.createElement("a");
    a.href = url;
    a.download = "LV_Export_" + new Date().toISOString().slice(0,10) + ".xlsx";
    a.click();
    
    // Cloud Upload (Opsiyonel)
    if (document.getElementById('chkCloud').checked && APPS_SCRIPT_URL) {
      sendToCloud(blob, a.download);
    }
  }

  function sendToCloud(blob, name) {
    const reader = new FileReader();
    reader.readAsDataURL(blob);
    reader.onloadend = () => {
      const base64 = reader.result.split(',')[1];
      fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ name: name, data: base64, mime: 'application/xlsx' })
      }).catch(e => console.log('Cloud log hatasÄ± (Ã¶nemsiz):', e));
    };
  }
</script>
</body>
</html>
