<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LVtoExcel Pro V8.1 - UI Fix</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root { --primary: #0969da; --border:#d0d7de; --bg:#f6f8fa; --white:#ffffff; --danger:rgba(207, 34, 46, 0.4); --success:#2da44e; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 0; background:var(--bg); }
    
    .navbar { background: #24292f; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
    .container { max-width: 100%; margin: 10px auto; padding: 0 15px; display: flex; flex-direction: column; gap: 15px; }
    
    .card { background: var(--white); border: 1px solid var(--border); border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .toolbar { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    
    .btn { padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; border: 1px solid rgba(27,31,36,0.15); transition: 0.2s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-secondary { background: #eee; }

    /* PDF Viewer Area - UI FIX BURADA */
    #viewer-outer { 
        position: relative; background: #525659; border-radius: 8px; 
        overflow: auto; display: flex; justify-content: center; 
        max-height: 85vh; min-height: 500px; 
        padding: 100px 40px 40px 40px; /* Üstten 100px boşluk kutuların görünmesini sağlar */
    }
    #canvas-wrapper { position: relative; display: inline-block; }
    canvas { display: block; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    .guide-layer { position: absolute; top: 0; left: 0; cursor: crosshair; z-index: 100; }

    /* Sütun Ayarları Kutuları - UX FIX */
    #header-overlay { 
        position: absolute; top: -85px; left: 0; width: 100%; height: 85px; 
        pointer-events: none; z-index: 200; 
    }
    .col-box { 
        position: absolute; height: 80px; background: rgba(255,255,255,0.98); border: 1px solid #999; 
        border-bottom: 4px solid var(--primary); pointer-events: auto; padding: 6px; font-size: 10px; box-sizing: border-box;
        display: flex; flex-direction: column; gap: 3px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .col-box.master { border-bottom-color: #2da44e; background: #f0fff4; border-bottom-width: 5px; }
    .col-box input[type="text"] { font-size: 10px; padding: 2px; border: 1px solid #ddd; border-radius: 3px; }
    .regex-input { font-size: 9px !important; color: #d73a49; border-color: #fca2ad !important; background: #fff5f5; }

    .zoom-ctrl { display: flex; align-items: center; gap: 5px; background: white; padding: 5px 10px; border-radius: 20px; border: 1px solid #ddd; }
    .range-input { width: 50px; padding: 4px; }
    
    table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f6f8fa; position: sticky; top: 0; }
  </style>
</head>
<body>

<nav class="navbar">
  <div style="font-weight: bold;">LVtoExcel Pro <span style="color:#2da44e">V8.1 (UI Fix)</span></div>
  <div class="toolbar">
    <select id="langSelect" onchange="updateLocale()">
      <option value="tr">Türkçe</option>
      <option value="de">Deutsch</option>
      <option value="en">English</option>
    </select>
    <input type="file" id="fileInput" accept="application/pdf" />
  </div>
</nav>

<div class="container">
  <div class="card toolbar">
    <div class="zoom-ctrl">
        <button onclick="changeZoom(-0.2)" class="btn btn-secondary">-</button>
        <span id="zoomVal">130%</span>
        <button onclick="changeZoom(0.2)" class="btn btn-secondary">+</button>
    </div>
    <button id="btnPrev" class="btn">←</button>
    <span id="pageInfo">0 / 0</span>
    <button id="btnNext" class="btn">→</button>
    <div style="border-left: 1px solid #ddd; padding-left: 10px;">
        Aralık: <input type="number" id="pageStart" class="range-input" value="1"> - <input type="number" id="pageEnd" class="range-input" value="1">
    </div>
    <div style="flex-grow:1"></div>
    <button id="btnExtract" class="btn btn-primary" disabled>Veriyi Çek</button>
    <button id="btnExport" class="btn btn-success" disabled>Excel Aktar</button>
  </div>

  <div id="viewer-outer">
    <div id="canvas-wrapper">
      <div id="header-overlay"></div>
      <canvas id="pdf-canvas"></canvas>
      <canvas id="guide-canvas" class="guide-layer"></canvas>
    </div>
  </div>

  <div class="card">
    <div id="previewArea" style="overflow-x: auto; max-height: 500px;"></div>
  </div>
</div>

<script>
/** AYNI ENGINE VE LOGIC SAKLANDI, SADECE UI IYILESTIRILDI **/
const VALID_EINHEITEN = new Set(['%', '°', '°C', 'A', 'AE', 'Bd', 'E', 'Hz', 'K', 'LE', 'ME', 'MW', 'N', 'Pa', 'V', 'VE', 'W', 'Wo', 'a', 'bar', 'cbm', 'cd', 'cm', 'cm2', 'cm3', 'cm²', 'cm³', 'd', 'dB', 'dm', 'Einheit', 'g', 'Grad', 'h', 'Jahr', 'kg', 'km', 'kN', 'kNm', 'kPa', 'kV', 'kW', 'kWh', 'l', 'lfm', 'lx', 'm', 'm2', 'm2Mt', 'm2Wo', 'm2d', 'm3', 'm3Mt', 'm3Wo', 'm3d', 'm²', 'm²Mt', 'm²Wo', 'm²d', 'm³', 'm³Mt', 'm³Wo', 'm³d', 'ma', 'mbar', 'md', 'mg', 'mh', 'mm', 'mMt', 'mWo', 'Monat', 'Mon', 'MPa', 'Mt', 'Nm', 'Paar', 'Pau', 'Prozent', 'Psch', 'Satz', 'Set', 'St', 'Std', 'Stk', 'Stk.', 'Sth', 'StMt', 'StWo', 'Stunde', 'Stück', 'Tag', 't', 'td', 'tMt', 'to', 'Tonne', 'tWo', 'Woche', 'pauschal', 'psch', 'qm', 'µg']);
const MENGE_PATTERNS = [/^0+\d*(\.\d+)?$/, /^\d+(\.\d+)?$/, /^\d+(\.\d*)*$/, /^\d+\s\d+$/, /^\d+\.\s\d+$/, /^\d{1,3}(\.\d{3})*,\d{2}$/, /^\d{1,3}(\.\d{3})*,\d{3}$/, /^\d+,\d{2}$/];

let pdfDoc = null, pageNum = 1, currentScale = 1.3, lang = 'tr';
let canvas = document.getElementById('pdf-canvas'), ctx = canvas.getContext('2d');
let gCanvas = document.getElementById('guide-canvas'), gCtx = gCanvas.getContext('2d');
let guides = { header: 0.08, footer: 0.92, cols: [0.1, 0.45, 0.6, 0.75, 0.88] };
let colSettings = [], masterColIdx = 0, isDragging = false, dragTarget = null;

const i18n = {
    tr: { master: "Ana", types: ["Metin", "Pozisyon", "Miktar", "Para"], extract: "Veriyi Çek", export: "Excel Aktar" },
    de: { master: "Anker", types: ["Text", "Position", "Menge", "Euro"], extract: "Extrahieren", export: "Export" },
    en: { master: "Master", types: ["Text", "Position", "Qty", "Currency"], extract: "Extract", export: "Export" }
};

document.getElementById('fileInput').onchange = async (e) => {
    const ab = await e.target.files[0].arrayBuffer();
    pdfDoc = await pdfjsLib.getDocument(ab).promise;
    document.getElementById('pageEnd').value = pdfDoc.numPages;
    document.getElementById('btnExtract').disabled = false;
    renderPage(1);
};

function changeZoom(delta) {
    currentScale = Math.min(3, Math.max(0.5, currentScale + delta));
    document.getElementById('zoomVal').innerText = Math.round(currentScale * 100) + "%";
    renderPage(pageNum);
}

async function renderPage(num) {
    if (!pdfDoc || num < 1 || num > pdfDoc.numPages) return;
    pageNum = num;
    document.getElementById('pageInfo').innerText = `${pageNum} / ${pdfDoc.numPages}`;
    const page = await pdfDoc.getPage(num);
    const vp = page.getViewport({ scale: currentScale });
    canvas.width = gCanvas.width = vp.width;
    canvas.height = gCanvas.height = vp.height;
    await page.render({ canvasContext: ctx, viewport: vp }).promise;
    drawGuides();
}

function drawGuides() {
    const w = gCanvas.width, h = gCanvas.height;
    gCtx.clearRect(0, 0, w, h);
    gCtx.fillStyle = "rgba(207, 34, 46, 0.2)";
    gCtx.fillRect(0, 0, w, guides.header * h);
    gCtx.fillRect(0, guides.footer * h, w, h * (1 - guides.footer));
    gCtx.strokeStyle = "#cf222e"; gCtx.lineWidth = 2;
    [guides.header, guides.footer].forEach(y => { gCtx.beginPath(); gCtx.moveTo(0, y*h); gCtx.lineTo(w, y*h); gCtx.stroke(); });
    gCtx.strokeStyle = "#0969da"; gCtx.lineWidth = 1; gCtx.setLineDash([5, 3]);
    guides.cols.forEach(x => { gCtx.beginPath(); gCtx.moveTo(x*w, 0); gCtx.lineTo(x*w, h); gCtx.stroke(); });
    gCtx.setLineDash([]);
    updateHeaderOverlay();
}

function updateHeaderOverlay() {
    const overlay = document.getElementById('header-overlay');
    overlay.innerHTML = "";
    const bounds = [0, ...guides.cols, 1];
    bounds.slice(0, -1).forEach((b, i) => {
        if(!colSettings[i]) colSettings[i] = { title: `Sütun ${i+1}`, type: 'text', regex: '^(\\d+\\.)+(\\.*_*;*\\**)?(\\d+\\.?[A-Za-z]?)$' };
        const box = document.createElement('div');
        box.className = 'col-box' + (i === masterColIdx ? ' master' : '');
        box.style.left = (b * 100) + "%";
        box.style.width = ((bounds[i+1] - b) * 100) + "%";
        box.innerHTML = `
            <input type="text" value="${colSettings[i].title}" oninput="colSettings[${i}].title=this.value" placeholder="Başlık">
            <select onchange="colSettings[${i}].type=this.value; updateHeaderOverlay();">
                <option value="text" ${colSettings[i].type==='text'?'selected':''}>${i18n[lang].types[0]}</option>
                <option value="pos" ${colSettings[i].type==='pos'?'selected':''}>${i18n[lang].types[1]}</option>
                <option value="menge" ${colSettings[i].type==='menge'?'selected':''}>${i18n[lang].types[2]}</option>
                <option value="currency" ${colSettings[i].type==='currency'?'selected':''}>${i18n[lang].types[3]}</option>
            </select>
            ${colSettings[i].type === 'pos' ? `<input type="text" class="regex-input" value="${colSettings[i].regex}" oninput="colSettings[${i}].regex=this.value" title="Pozisyon Regex">` : ''}
            <label style="display:flex; align-items:center; gap:4px; margin-top:2px; cursor:pointer;">
                <input type="radio" name="m" ${i===masterColIdx?'checked':''} onclick="masterColIdx=${i}; drawGuides();"> <b>${i18n[lang].master}</b>
            </label>
        `;
        overlay.appendChild(box);
    });
}

gCanvas.onmousedown = (e) => {
    const rect = gCanvas.getBoundingClientRect();
    const x = (e.clientX - rect.left) / gCanvas.width;
    const y = (e.clientY - rect.top) / gCanvas.height;
    if(Math.abs(y - guides.header) < 0.02) { isDragging = true; dragTarget = 'h'; return; }
    if(Math.abs(y - guides.footer) < 0.02) { isDragging = true; dragTarget = 'f'; return; }
    let cIdx = guides.cols.findIndex(c => Math.abs(c - x) < 0.015);
    if(cIdx !== -1) { isDragging = true; dragTarget = cIdx; }
    else if(e.button === 0) { guides.cols.push(x); guides.cols.sort((a,b)=>a-b); colSettings = []; drawGuides(); }
};
gCanvas.oncontextmenu = (e) => {
    e.preventDefault();
    const rect = gCanvas.getBoundingClientRect();
    const x = (e.clientX - rect.left) / gCanvas.width;
    let cIdx = guides.cols.findIndex(c => Math.abs(c - x) < 0.02);
    if(cIdx !== -1) { guides.cols.splice(cIdx, 1); colSettings = []; drawGuides(); }
};
window.onmousemove = (e) => {
    if(!isDragging) return;
    const rect = gCanvas.getBoundingClientRect();
    const x = (e.clientX - rect.left) / gCanvas.width;
    const y = (e.clientY - rect.top) / gCanvas.height;
    if(dragTarget === 'h') guides.header = y;
    else if(dragTarget === 'f') guides.footer = y;
    else if(typeof dragTarget === 'number') guides.cols[dragTarget] = x;
    drawGuides();
};
window.onmouseup = () => isDragging = false;

document.getElementById('btnExtract').onclick = async () => {
    let extractedRows = [];
    const start = parseInt(document.getElementById('pageStart').value), end = parseInt(document.getElementById('pageEnd').value);
    const colCount = guides.cols.length + 1;
    for (let p = start; p <= end; p++) {
        const page = await pdfDoc.getPage(p), text = await page.getTextContent();
        const vp = page.getViewport({ scale: 1.0 }), h = vp.height, w = vp.width;
        let items = text.items.map(it => {
            const [vx, vy] = vp.convertToViewportPoint(it.transform[4], it.transform[5]);
            return { str: it.str, x: vx, y: vy };
        }).filter(it => it.y > guides.header*h && it.y < guides.footer*h);
        items.sort((a, b) => Math.abs(a.y - b.y) < 7 ? a.x - b.x : a.y - b.y);
        let lines = [];
        items.forEach(it => {
            let last = lines[lines.length-1];
            if(!last || Math.abs(it.y - last.y) > 8) { lines.push({ y: it.y, cells: new Array(colCount).fill("") }); last = lines[lines.length-1]; }
            let cIdx = 0; for(let i=0; i<guides.cols.length; i++) if(it.x > guides.cols[i]*w) cIdx = i+1;
            last.cells[cIdx] += (last.cells[cIdx] ? " " : "") + it.str.trim();
        });
        lines.forEach(line => {
            const masterContent = line.cells[masterColIdx].trim();
            const config = colSettings[masterColIdx];
            let isNewRow = (config.type === 'pos') ? new RegExp(config.regex).test(masterContent) : masterContent.length > 0;
            if(isNewRow || extractedRows.length === 0) extractedRows.push([...line.cells]);
            else { let last = extractedRows[extractedRows.length - 1]; line.cells.forEach((c, i) => { if(c) last[i] += "\n" + c; }); }
        });
    }
    renderPreview(extractedRows);
};

function renderPreview(data) {
    const div = document.getElementById('previewArea');
    let h = `<table><tr>${colSettings.map(s => `<th>${s.title}</th>`).join('')}</tr>`;
    data.forEach(r => h += `<tr>${r.map(c => `<td>${c.replace(/\n/g,'<br>')}</td>`).join('')}</tr>`);
    div.innerHTML = h + `</table>`;
    window.lastExtracted = data; document.getElementById('btnExport').disabled = false;
}

document.getElementById('btnExport').onclick = () => {
    const sheetData = [colSettings.map(s => s.title)];
    window.lastExtracted.forEach(row => {
        sheetData.push(row.map((cell, i) => {
            const type = colSettings[i].type;
            if(type === 'text' || type === 'pos') return cell;
            let n = cell.replace(/[^0-9,.-]/g, '').replace(',','.');
            return parseFloat(n) || cell;
        }));
    });
    const ws = XLSX.utils.aoa_to_sheet(sheetData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Export");
    XLSX.writeFile(wb, `LV_Export_V8.xlsx`);
};

function updateLocale() {
    lang = document.getElementById('langSelect').value;
    document.getElementById('btnExtract').innerText = i18n[lang].extract;
    document.getElementById('btnExport').innerText = i18n[lang].export;
    updateHeaderOverlay();
}
document.getElementById('btnPrev').onclick = () => renderPage(pageNum-1);
document.getElementById('btnNext').onclick = () => renderPage(pageNum+1);
updateLocale();
</script>
</body>
</html>
